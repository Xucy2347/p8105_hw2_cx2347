---
title: "p8105_hw2_cx2347"
author: "Chuyuan XU"
date: "2025-09-23"
output: html_document
---

```{r setup, message=FALSE}
library(tidyverse)
library(tidyr)
library(readxl)
```

# Problem 1

```{r pols-month, message=FALSE}
# clean the data in pols-month.csv
pols = read_csv(
  "data/FiveThirtyEight_data/pols-month.csv",
  na = c("NA", ".", "")
  ) |>
  janitor::clean_names() |>
  
  # break up the variable 'mon' into 'year', 'month' and 'day'
  separate(
    mon,
    into = c('year', 'month', 'day'),
    sep = '-'
  ) |>
  
  # change the format of 'year' and 'month'
  mutate(
    year = as.numeric(year),
    month = as.numeric(month),
    month = month(month, label = TRUE, abbr=FALSE)
  ) |>
  
  # create the variable 'president' and drop 'prez_gop and 'prez_dem' 
  # include the logic 
  pivot_longer(
    cols = c(prez_gop, prez_dem),
    names_to = 'president',
    values_to = 'ind'
  ) |>
  filter(ind != 0) |>
  mutate(president = case_match(
    president,
    'prez_gop' ~ 'gop',
    'prez_dem' ~ 'dem'
  )) |>
  select(-ind) |>
  
  # drop the 'day' variable
  select(-day) |>
  
  # arrange the dataset
  select(year, month, everything()) |>
  arrange(year, month)
```

```{r snp, message=FALSE}
# clean the data in snp.csv
snp = 
  read_csv(
    "data/FiveThirtyEight_data/snp.csv",
    na = c("NA", ".", "")
  ) |>
  janitor::clean_names() |>
  
  # break up the get 'year', 'month' from variable 'date'
  mutate(
    date = 
      parse_date_time2(
        date, 
        orders="m/d/y", 
        cutoff_2000 = 20L
      )
    ) |> 
  mutate(year = year(date)) |>
  mutate(month = month(date, label = TRUE, abbr = FALSE)) |>
  
  # rearrange the data and drop the 'date' variable
  select(year, month, everything(), -date) |>
  arrange(year, month)
```

```{r unemployment, message=FALSE}
# clean the data in unemployment.csv
ue = 
  read_csv(
    "data/FiveThirtyEight_data/unemployment.csv",
    na = c("NA", ".", "")
  ) |>
  janitor::clean_names() |>
  
  # switch from wide to long format
  pivot_longer(
    cols = jan:dec,
    names_to = 'month',
    values_to = 'unemployment',
  ) |>

  # change the format of the month
  mutate(
    month = match(month, tolower(month.abb))
    ) |>
  mutate(month = month(month, label =TRUE, abbr = FALSE)) |>
  arrange(year, month)
```

```{r merging, message=FALSE}
# Join the datasets by merging snp into pols
result = left_join(pols, snp, by = c('year', 'month'))

# merging unemployment into the result.
result = left_join(result, ue, by = c('year', 'month'))
```

### reporting the datasets:

The dataset `pols` contains variables related to the number of politicians who are democratic or republican in national institutes.
The year range of the dataset is between `r min(pull(pols, year))` and `r max(pull(pols, year))`.
There are `r nrow(pols)` rows and `r ncol(pols)` columns in the data frame.
This dataset includes `r ncol(pols)` variables:
  `year`, `month` (the year and month when the number was counted),
  `gov_gop` (the number of republican governors on the associated date),
  `sen_gop` (the number of republican senators on the associated date),
  `rep_gop` (the number of republican representatives on the associated date),
  `gov_dem` (the number of democratic governors on the associated date),
  `sen_dem` (the number of democratic senators on the associated date),
  `rep_dem` (the number of democratic representatives on the associated date),
  `president` (on the associated year and month, whether the president is republican (gop) or democratic (dem)).
\
\
The dataset `snp` records the closing values of the S&P stock index in the associated year and month with the variable `close.`
The year range of the dataset is between `r min(pull(snp, year))` and `r max(pull(snp, year))`.
There are `r nrow(snp)` rows and `r ncol(snp)` columns in the data frame.
This dataset includes `r ncol(snp)` variables. Besides the variable `close`, variables `year` and `month` are the year and month when the number was counted.
\
\
The dataset `ue` records the percentage of the unemployment rate in the associated year and month with the variable `unemployment`.
The year range of the dataset is between `r min(pull(ue, year))` and `r max(pull(ue, year))`.
There are `r nrow(ue)` rows and `r ncol(ue)` columns in the data frame.
This dataset includes `r ncol(ue)` variables. Besides the variable `unemployment`, variables `year` and `month` are the year and month when the number was counted.
\
\
The final `result` dataset is merged from the datasets mentioned above.
The year range of the dataset is between `r min(pull(result, year))` and `r max(pull(result, year))`.
There are `r nrow(result)` rows and `r ncol(result)` columns in the data frame.
This dataset includes `r ncol(result)` variables included:
  `year`, `month` (the year and month when the number was counted),
  `gov_gop` (the number of republican governors on the associated date),
  `sen_gop` (the number of republican senators on the associated date),
  `rep_gop` (the number of republican representatives on the associated date),
  `gov_dem` (the number of democratic governors on the associated date),
  `sen_dem` (the number of democratic senators on the associated date),
  `rep_dem` (the number of democratic representatives on the associated date),
  `president` (on the associated year and month, whether the president is republican or democratic).
  `close` (the closing values of the S&P stock index in the associated year and month),
  `unemployment` (the percentage of the unemployment rate in the associated year and month).
Among those variables: 
  `year` and `month` are used to merge three datasets; 
  `gov_gop`, `sen_gop`, `rep_gop`, `gov_dem`, `sen_dem`, `rep_dem` and `president` come from the dataset `pol`;
  `close` comes from the dataset `snp`;
  `unemployment` comes from the dataset `ue`.



# Problem 2

```{r Mr. Trash Wheel}
mr_df = 
  read_excel(
    "data/202509 Trash Wheel Collection Data.xlsx", 
    sheet = "Mr. Trash Wheel", 
    range = "A2:N709"
    ) |> 
  janitor::clean_names() |>
  
  # omit lines without dumpster-specific data
  filter(!is.na(dumpster)) |>
  
  # convert the format the 'year'
  mutate(year = as.numeric(year)) |>

  # round the numbers of sport balls
  mutate(sports_balls = as.integer(sports_balls)) |>
  
  # keep track of which Trash wheel this is 
  mutate(trash_wheel = "Mr. Trash Wheel")
```

```{r Professor Trash Wheel}
prof_df =
  read_excel(
    "data/202509 Trash Wheel Collection Data.xlsx", 
    sheet = "Professor Trash Wheel", 
    range = "A2:M134"
    ) |>
  janitor::clean_names() |>
  
  # omit lines without dumpster-specific data
  filter(!is.na(dumpster)) |>
  
  # keep track of which Trash wheel this is 
  mutate(trash_wheel = "Professor Trash Wheel")

```

```{r Gwynnda Trash Wheel}
gwyn_df =
  read_excel(
    "data/202509 Trash Wheel Collection Data.xlsx", 
    sheet = "Gwynns Falls Trash Wheel", 
    range = "A2:L351"
    ) |>
  janitor::clean_names() |>
  
  # omit lines without dumpster-specific data
  filter(!is.na(dumpster)) |> 
  
  # keep track of which Trash wheel this is 
  mutate(trash_wheel = "Gwynns Falls Trash Wheel")
```

```{r bind rows}
# combine the three dataset
wheel_df = 
  bind_rows(
    mr_df, 
    prof_df,
    gwyn_df
  ) |>
  select(dumpster, year, month, date, trash_wheel, everything())
```

```{r calcuate num of cigarette_butts, echo=FALSE, include=FALSE}
# prepare the information of Gwynnda in June of 2022
cig_sum = 
  gwyn_df |>
  filter(month == "June" & year==2022)
```

### reporting the datasets:
The dataset `mr_df` collects information of the "Mr. Trash Wheel" on the dumpster number, date of collection, amount of total litter and litter type 
from `r min(pull(mr_df, date))` to `r max(pull(mr_df, date))`.
There are `r nrow(mr_df)` rows and `r ncol(mr_df)` columns in the dataset.
This dataset includes `r ncol(mr_df)` variables:
  `dumpster` (the dumpster number);
  `month`, `year` and `date`(the month, year, and date are the time of data collection);
  `weight_tons` (the weight of the dumpster collected in tons);
  `volume_cubic_yards` (the volumn of the dumpster collected in cubic yards);
  `plastic_bottles`, `polystyrene`, `cigarette_butts`, `glass_bottles`, 
  `plastic_bags`, `wrappers`, and `sports_balls` (numbers of different litter types in the associated dumpsters);
  `homes_powered` (the numbers of home powered from electricity made from the trash collected)
  `trash_wheel` (the variable generated to indicate that these dumpsters were collected by the Mr. Trash Wheel).
\
\
The dataset `prof_df` collects information of the "Professor Trash Wheel" on the dumpster number, date of collection, amount of total litter and litter type
from `r min(pull(prof_df, date))` to `r max(pull(prof_df, date))`.
There are `r nrow(prof_df)` rows and `r ncol(prof_df)` columns in the dataset.
This dataset includes `r ncol(prof_df)` variables:
  `dumpster` (the dumpster number);
  `month`, `year` and `date`(the month, year, and date are the time of data collection);
  `weight_tons` (the weight of the dumpster collected in tons);
  `volume_cubic_yards` (the volumn of the dumpster collected in cubic yards);
  `plastic_bottles`, `polystyrene`, `cigarette_butts`, `glass_bottles`, 
  `plastic_bags` and `wrappers` (numbers of different litter types in the associated dumpsters);
  `homes_powered` (the numbers of home powered from electricity made from the trash collected)
  `trash_wheel` (the variable generated to indicate that these dumpsters were collected by the Professor Trash Wheel).
\
\
The dataset `gwyn_df` collects information of the "Gwynnda Trash Wheel" on the dumpster number, date of collection, amount of total litter and litter type
from `r min(pull(gwyn_df, date))` to `r max(pull(gwyn_df, date))`.
There are `r nrow(gwyn_df)` rows and `r ncol(gwyn_df)` columns in the dataset.
This dataset includes `r ncol(gwyn_df)` variables:
  `dumpster` (the dumpster number);
  `month`, `year` and `date`(the month, year, and date are the time of data collection);
  `weight_tons` (the weight of the dumpster collected in tons);
  `volume_cubic_yards` (the volumn of the dumpster collected in cubic yards);
  `plastic_bottles`, `polystyrene`, `cigarette_butts`, `plastic_bags` and `wrappers` (numbers of different litter types in the associated dumpsters);
  `homes_powered` (the numbers of home powered from electricity made from the trash collected)
  `trash_wheel` (the variable generated to indicate that these dumpsters were collected by the Gwynnda Trash Wheel).
\
\
The dataset `wheel_df` were combined from the above three datasets, including the information from `r unique(pull(wheel_df, trash_wheel))`.
There are `r nrow(wheel_df)` observation and `r ncol(wheel_df)` variables in the dataset.
This dataset includes `r ncol(wheel_df)` variables:
  `dumpster` (the dumpster number);
  `year`, `month` and `date`(the month, year, and date are the time of data collection);
  `weight_tons` (the weight of the dumpster collected in tons);
  `volume_cubic_yards` (the volumn of the dumpster collected in cubic yards);
  `plastic_bottles`, `polystyrene`, `cigarette_butts`, `glass_bottles`, 
  `plastic_bags`, `wrappers`, and `sports_balls` (numbers of different litter types in the associated dumpsters);
  `homes_powered` (the numbers of home powered from electricity made from the trash collected)
  `trash_wheel` (the variable generated to indicate which Trash Wheel collected the associate dumpster).
The data from `r min(pull(wheel_df, date), na.rm = TRUE)` to `r max(pull(wheel_df, date), na.rm = TRUE)` is collected.
For available data, 
the total weight of trash collected by Professor Trash Wheel is `r sum(pull(prof_df, weight_tons), na.rm = TRUE)` tons;
the total number of cigarette butts collected by Gwynnda in June of 2022 is `r format(sum(pull(cig_sum, cigarette_butts)), scientific=FALSE)`.

# Problem 3

```{r import, message = FALSE}
zori_df = 
  read_csv(
    "data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv",
    na = c("NA",".","")
  ) |>
  janitor::clean_names()

zip_df = 
  read_csv(
    "data/zillow_data/Zip Codes.csv",
    na = c("NA",".","")
  ) |>
  janitor::clean_names() |>
  mutate(
    region_name = zip_code,
    county_name = paste0(county, " County")
  )
```

```{r merge}
# join to data frames by "county_name", "region_names"
zillow = 
  left_join(
    zori_df,
    zip_df,
    by = c("county_name", "region_name")
  ) |>
    
  # reorganize the variables
  select(
    size_rank, 
    region_id, region_name, region_type, zip_code,
    state, state_name, state_fips, 
    city, metro,
    county, county_name, county_code, county_fips,
    neighborhood, file_date,
    everything()
  ) |>
  
  # rearrange the obs
  arrange(size_rank)

# get the data frame where ZIP codes appear in the ZIP code dataset but not in the Zillow Rental Price dataset
zillow_non = 
  anti_join(
    zip_df,
    zori_df,
    by = "region_name"
  ) |>
  arrange(zip_code)
```

### reporting the dataset
The dataset `zillow` were combined from the `zip_df` and `zori_df`, 
including the information of the Zillow Observed Rent Index in New York City between January 2015 and August 2024.
There are `r nrow(zillow)` observation and `r ncol(zillow)` variables in the dataset.
The variables covered information related to 
  the geo information on state, county, neighborhood and zip codes (eg. `region_name`, `state_fips` and so on), 
  the rental price for each month between January 2015 and August 2024 (eg. `x2015_01_31`), 
  and the rank of sizes (`size_rank`).
There are `r length(unique(pull(zillow, region_name)))` unique ZIP codes
  and `r length(unique(pull(zillow, neighborhood)))` unique neighborhoods in the dataset.
\
\
There are `r length(unique(pull(zillow_non, region_name)))` ZIP codes only appear in the ZIP code list but not in the Zillow Rental Price dataset, 
which are: `r format(unique(pull(zillow_non, region_name)), scientific = FALSE)`.
The reason that these ZIP codes are excluded might be due to:\
&emsp; 1) some ZIP codes do not have a neighborhood or does not record the neighborhood in it. For example, for the area with ZIP codes of 10499, the neighborhood is listed as NA. So, it is unlikely that there are many properties rental or sales. Therefore, they will be excluded from the Zillow Observed Rental Dataset.\
&emsp; 2) among zip codes with a neighborhood value, they might be in places where the rental properties are scarce, either due to not many house properties or due to most of them are personal properties not for rents.\
&emsp; 3) other concerns on privacy, limitations of data collection and so on can also result in exclusion of those ZIP codes.

```{r compare}
# compare rental prices in January 2021 to prices in January 2020
zillow_compare = 
  zillow |>
  
  # create a new variable that measures the drop in prices
  mutate(
    drop_in_price = x2020_01_31 - x2021_01_31,
  ) |>
  
  # rearrange the data frame with descending drop in prices and give them rankings
  arrange(
    desc(drop_in_price)
  ) |>
  mutate(
    rank = 1:dim(zillow)[1]
  ) |>
  
  # filter out first 10 zip codes
  filter(rank <= 10) |>
  select(zip_code, county_name, neighborhood, drop_in_price)

# print out the table
zillow_compare
```

The table above shows the 10 ZIP codes with largest drop in rental price from January 2020 to 2021.